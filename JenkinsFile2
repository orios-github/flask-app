pipeline {
    agent any               // Run the pipeline on any available Jenkins agent

    environment {
        VERSION = "v${BUILD_NUMBER}"             // Define an environment variable VERSION using Jenkins build number
    }

    stages {
        stage('Checkout') {
            steps {
                checkout([$class: 'GitSCM',
                          branches: [[name: '*/master']],         // Checkout the master branch (or main if renamed)
                          userRemoteConfigs: [[url: 'https://github.com/orios-github/flask-app.git',
                                               credentialsId: 'jenkins-push-token']]])     // Use stored GitHub credentials
            }
        }

        stage('Build') {
            steps {
                sh "docker build -t oscar8899/flask-app:${VERSION} ."         // Build Docker image tagged with the current VERSION (e.g., v12)
            }
        }

        stage('Push') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'oscar8899-dockerHub',
                                                 usernameVariable: 'USER',
                                                 passwordVariable: 'PASS')]) {
                    sh """
                      echo $PASS | docker login -u $USER --password-stdin          // Authenticate to DockerHub securely
                      docker push oscar8899/flask-app:${VERSION}                   // Push versioned image to DockerHub
                      docker tag oscar8899/flask-app:${VERSION} oscar8899/flask-app:latest   // Tag image as 'latest'
                      docker push oscar8899/flask-app:latest                       // Push 'latest' tag to DockerHub
                    """
                }
            }
        }   

        stage('Update Manifest') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'jenkins-push-token',
                                                  usernameVariable: 'GIT_USER',
                                                  passwordVariable: 'GIT_PASS')]) {
                    sh """
                      sed -i "s|image: oscar8899/flask-app:.*|image: oscar8899/flask-app:v${BUILD_NUMBER}|g" k8s/deployment.yaml     // Update Kubernetes deployment.yaml with the new image version
                      git config --global user.email "jenkins@ci.local"      // Configure Git user email
                      git config --global user.name "Jenkins CI"             // Configure Git username
                      git checkout -B master origin/master                   // Ensure working on master branch
                      git add k8s/deployment.yaml                            // Stage updated manifest file
                      git commit -m "Update image tag to v${BUILD_NUMBER}" || echo "No changes"  // Commit changes (skip if no diff)
                      git pull --rebase https://${GIT_USER}:${GIT_PASS}@github.com/orios-github/flask-app.git master     // Rebase with remote master to avoid conflicts
                      git push https://${GIT_USER}:${GIT_PASS}@github.com/orios-github/flask-app.git master     // Push updated manifest back to GitHub
                    """
                }
            }
        }

        stage('Deploy') {
            steps {
                sh """
                  export KUBECONFIG=/var/lib/jenkins/.kube/config         // Point kubectl to Jenkins' kubeconfig
                  kubectl apply -f k8s/deployment.yaml                    // Apply updated manifest to Kubernetes cluster
                """
            }
        }
    }
}
